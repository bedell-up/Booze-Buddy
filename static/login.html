<!-- login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - Booze Buddy</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="message" style="display:none;"></div>

    <div>
        <button class="auth-tab active" data-tab="login">Login</button>
        <button class="auth-tab" data-tab="register">Register</button>
    </div>

    <form id="login-form" class="auth-form active">
        <input type="text" id="login-username" placeholder="Username" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Login</button>
    </form>

    <form id="register-form" class="auth-form">
        <input type="text" id="register-username" placeholder="Username" required />
        <input type="email" id="register-email" placeholder="Email" required />
        <input type="password" id="register-password" placeholder="Password" required />
        <input type="password" id="register-confirm-password" placeholder="Confirm Password" required />
        <button type="submit">Register</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Login page loaded, clearing any existing tokens");
            localStorage.removeItem('token');
            localStorage.removeItem('token_type');
        });

        let API_BASE_URL = window.location.origin;
        const currentHost = window.location.hostname;
        const hostWithoutWWW = currentHost.replace('www.', '');
        API_BASE_URL = `${window.location.protocol}//${hostWithoutWWW}`;

        console.log("Using API_BASE_URL:", API_BASE_URL);

        const authTabs = document.querySelectorAll('.auth-tab');
        const authForms = document.querySelectorAll('.auth-form');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const messageBox = document.getElementById('message');

        authTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                authTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                authForms.forEach(form => form.classList.remove('active'));
                if (tabId === 'login') {
                    loginForm.classList.add('active');
                } else {
                    registerForm.classList.add('active');
                }
                hideMessage();
            });
        });

        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `message message-${type}`;
            messageBox.style.display = 'block';
            messageBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideMessage() {
            messageBox.style.display = 'none';
        }

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            showMessage('Logging in...', 'info');

            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);

                console.log("Sending login request to:", `${API_BASE_URL}/token`);

                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    body: formData
                });

                console.log("Login response status:", response.status);

                if (!response.ok) {
                    let errorMessage = 'Login failed. Please check your credentials.';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {}
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                localStorage.setItem('token', data.access_token);
                localStorage.setItem('token_type', data.token_type);

                showMessage('Login successful! Redirecting...', 'success');

                setTimeout(() => {
                    const appUrl = `${window.location.protocol}//${window.location.host}/app`;  // <== UPDATED HERE
                    console.log("Redirecting to:", appUrl);
                    window.location.href = appUrl;
                }, 1500);
            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message || 'Login failed. Please check your credentials.', 'error');
            }
        });

        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }

            try {
                showMessage('Creating account...', 'info');

                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                if (!response.ok) {
                    let errorMessage = 'Registration failed. Please try again.';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {}
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                showMessage('Registration successful! Please login.', 'success');
                registerForm.reset();
                authTabs[0].click();
            } catch (error) {
                console.error('Registration error:', error);
                showMessage(error.message || 'Registration failed. Please try again.', 'error');
            }
        });
    </script>
</body>
</html>
